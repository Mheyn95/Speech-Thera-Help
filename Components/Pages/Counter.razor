@page "/fluencycalculator"
@rendermode InteractiveServer
@using System.Timers

<PageTitle>Fluency Calculator</PageTitle>

<h1>Counter</h1>

<p role="status">Syllables: @syllableCount</p>

<button class="btn btn-primary" @onclick="IncrementSyllableCount" disabled="@(isStart ? false : true)">Syllable</button>

<p role="status">Stutters: @stutterCount</p>

<button class="btn btn-primary" @onclick="IncrementStutterCount" disabled="@(isStart ? false : true)">Stutter</button>

<p role="status">SPM: @spm.ToString("F2")</p>

<p role="status">SS%: @ssPerc.ToString("F2") %</p>

<button @onclick="ResetMetrics" disabled="@(isStart ? true : false)">Reset Metrics</button>

<h3>Timer</h3>

<div>
    <p>@elapsedTime</p>
    <button @onclick="ToggleTimer">@buttonText Timer</button>
    <button @onclick="ResetTimer">Reset Timer</button>
</div>

@code {
    private Timer _timer;
    private TimeSpan _elapsedTime;
    private DateTime _lastStartTime;
    private string elapsedTime = "00:00.000";
    private string buttonText = "Start";
    private bool isRunning = false;
    private TimeSpan totalElapsed;

    private double syllableCount = 0;
    private double stutterCount = 0;
    private double spm = 0;
    private double ssPerc = 0;

    private bool isStart = false;

    protected override void OnInitialized()
    {
        _timer = new Timer(10); // Update interval to 10 milliseconds
        _timer.Elapsed += OnTimerElapsed;
    }

    private void ToggleTimer()
    {
        if (isRunning)
        {
            _timer.Stop();
            _elapsedTime += DateTime.Now - _lastStartTime;
            buttonText = "Start";
            isStart = false; // Enable buttons when timer stops
        }
        else
        {
            _lastStartTime = DateTime.Now;
            _timer.Start();
            buttonText = "Stop";
            isStart = true; // Disable buttons when timer starts
        }
        isRunning = !isRunning;
        InvokeAsync(StateHasChanged); // Ensure state is updated
    }

    private void ResetTimer()
    {
        _timer.Stop();
        _elapsedTime = TimeSpan.Zero;
        elapsedTime = "00:00.000";
        buttonText = "Start";
        isRunning = false;
        isStart = false; // Ensure buttons are disabled after reset
        InvokeAsync(StateHasChanged); // Ensure state is updated
    }

    private void ResetMetrics()
    {
        syllableCount = 0;
        stutterCount = 0;
        spm = 0;
        ssPerc = 0;
        InvokeAsync(StateHasChanged); // Ensure state is updated
    }

    private void OnTimerElapsed(object sender, ElapsedEventArgs e)
    {
        var currentElapsed = DateTime.Now - _lastStartTime;
        totalElapsed = _elapsedTime + currentElapsed;
        elapsedTime = totalElapsed.ToString(@"mm\:ss\.fff");
        InvokeAsync(StateHasChanged);
    }

    private void IncrementSyllableCount()
    {
        syllableCount++;
        CalculateSPM();
        CalculateSSPercent();
    }

    private void IncrementStutterCount()
    {
        stutterCount++;
        CalculateSSPercent();
    }

    private void CalculateSPM()
    {
        double elapsedSeconds = totalElapsed.TotalSeconds;
        if (elapsedSeconds > 0)
        {
            spm = (syllableCount / elapsedSeconds) * 60;
        }
        else
        {
            spm = 0;
        }
    }

    private void CalculateSSPercent()
    {
        double elapsedSeconds = totalElapsed.TotalSeconds;
        if (elapsedSeconds > 0)
        {
            ssPerc = (stutterCount / (stutterCount + syllableCount)) * 100;
        }
        else
        {
            ssPerc = 0;
        }
    }
}